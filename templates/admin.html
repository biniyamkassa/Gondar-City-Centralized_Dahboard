<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="container">
        <h1>Admin Panel - bini_database</h1>

        <!-- Create User Section -->
        <div class="section">
            <h2>Create User</h2>
            <form id="createUserForm">
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="password" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="email" required>
                </div>
                <button type="submit" class="btn btn-primary">Create User</button>
            </form>
            <div id="userMessage"></div>
        </div>

        <!-- Create Table Section -->
        <div class="section">
            <h2>Create Table in bini_database</h2>
            <form id="createTableForm">
                <div class="form-group">
                    <label>Database:</label>
                    <input type="text" id="databaseName" value="bini_database" readonly class="readonly-field">
                    <small>All tables will be created in this database</small>
                </div>
                <div class="form-group">
                    <label>Table Name:</label>
                    <input type="text" id="tableName" required placeholder="Enter table name">
                </div>

                <div class="form-group">
                    <label>Assign to User (Optional):</label>
                    <select id="assignedUser">
                        <option value="">No specific user (available to all)</option>
                    </select>
                    <small>If assigned, only this user can submit data to this table</small>
                </div>

                <div class="form-group">
                    <h3>Table Columns</h3>
                    <div id="columnsContainer">
                        <!-- Columns will be added here dynamically -->
                    </div>
                    <button type="button" id="addColumnBtn" class="btn btn-secondary">Add Column</button>
                </div>

                <button type="submit" class="btn btn-primary">Create Table</button>
            </form>
            <div id="tableMessage"></div>
        </div>

        <!-- Assign Table to User Section -->
        <div class="section">
            <h2>Assign Table to User</h2>
            <form id="assignTableForm">
                <div class="form-group">
                    <label>Select User:</label>
                    <select id="assignUserSelect" required>
                        <option value="">Select User</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Select Table:</label>
                    <select id="assignTableSelect" required>
                        <option value="">Select Table</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Assign Table to User</button>
            </form>
            <div id="assignMessage"></div>
        </div>

        <!-- Existing Tables Section -->
        <div class="section">
            <h2>Existing Tables in bini_database</h2>
            <div id="tablesList">
                <p>Loading tables...</p>
            </div>
        </div>
    </div>

    <script>
        // Load existing tables
        function loadTables() {
            fetch('/get_tables')
                .then(response => response.json())
                .then(data => {
                    const tablesList = document.getElementById('tablesList');
                    if (data.success && data.tables.length > 0) {
                        tablesList.innerHTML = '<ul>' + data.tables.map(table =>
                            `<li>${table}</li>`
                        ).join('') + '</ul>';
                    } else {
                        tablesList.innerHTML = '<p>No tables found in bini_database.</p>';
                    }
                });
        }

        // Load users for assignment dropdowns
        function loadUsers() {
            fetch('/get_users')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const assignedUserSelect = document.getElementById('assignedUser');
                        const assignUserSelect = document.getElementById('assignUserSelect');

                        // Clear existing options except the first one
                        assignedUserSelect.innerHTML = '<option value="">No specific user (available to all)</option>';
                        assignUserSelect.innerHTML = '<option value="">Select User</option>';

                        data.users.forEach(user => {
                            // For create table form
                            const option1 = document.createElement('option');
                            option1.value = user;
                            option1.textContent = user;
                            assignedUserSelect.appendChild(option1);

                            // For assign table form
                            const option2 = document.createElement('option');
                            option2.value = user;
                            option2.textContent = user;
                            assignUserSelect.appendChild(option2);
                        });
                    }
                });
        }

        // Load tables for assignment
        function loadTablesForAssignment() {
            fetch('/get_tables')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const assignTableSelect = document.getElementById('assignTableSelect');
                        assignTableSelect.innerHTML = '<option value="">Select Table</option>';

                        data.tables.forEach(table => {
                            const option = document.createElement('option');
                            option.value = table;
                            option.textContent = table;
                            assignTableSelect.appendChild(option);
                        });
                    }
                });
        }

        // Load data on page load
        loadTables();
        loadUsers();
        loadTablesForAssignment();

        // Create User Form
        document.getElementById('createUserForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const userData = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                email: document.getElementById('email').value
            };

            fetch('/create_user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            })
                .then(response => response.json())
                .then(data => {
                    const messageDiv = document.getElementById('userMessage');
                    messageDiv.textContent = data.message;
                    messageDiv.className = data.success ? 'success' : 'error';

                    if (data.success) {
                        document.getElementById('createUserForm').reset();
                        // Reload users to include the new one
                        loadUsers();
                    }
                });
        });

        // Column management
        let columnCount = 0;

        function addColumn(name = '', type = 'VARCHAR(255)') {
            columnCount++;
            const columnDiv = document.createElement('div');
            columnDiv.className = 'column-row';
            columnDiv.innerHTML = `
                <div class="form-row">
                    <input type="text" placeholder="Column Name" class="column-name" value="${name}" required>
                    <select class="column-type" required>
                        <option value="VARCHAR(255)" ${type === 'VARCHAR(255)' ? 'selected' : ''}>Text (VARCHAR)</option>
                        <option value="INTEGER" ${type === 'INTEGER' ? 'selected' : ''}>Number (INTEGER)</option>
                        <option value="BOOLEAN" ${type === 'BOOLEAN' ? 'selected' : ''}>Boolean</option>
                        <option value="DATE" ${type === 'DATE' ? 'selected' : ''}>Date</option>
                        <option value="TEXT" ${type === 'TEXT' ? 'selected' : ''}>Long Text</option>
                        <option value="DECIMAL(10,2)" ${type === 'DECIMAL(10,2)' ? 'selected' : ''}>Decimal</option>
                    </select>
                    <button type="button" class="btn btn-secondary configure-dropdown" style="margin-left: 10px;">Configure Dropdown</button>
                    <button type="button" class="btn btn-danger remove-column">Remove</button>
                </div>
                <div class="dropdown-options-container" style="display: none; margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                    <h4>Dropdown Options for this Column</h4>
                    <div class="dropdown-options-list"></div>
                    <button type="button" class="btn btn-secondary add-dropdown-option">Add Option</button>
                </div>
            `;
            document.getElementById('columnsContainer').appendChild(columnDiv);

            // Add event listeners
            columnDiv.querySelector('.remove-column').addEventListener('click', function () {
                columnDiv.remove();
            });

            columnDiv.querySelector('.configure-dropdown').addEventListener('click', function () {
                const optionsContainer = columnDiv.querySelector('.dropdown-options-container');
                optionsContainer.style.display = optionsContainer.style.display === 'none' ? 'block' : 'none';
            });

            columnDiv.querySelector('.add-dropdown-option').addEventListener('click', function () {
                addDropdownOption(columnDiv);
            });
        }

        function addDropdownOption(columnDiv, value = '', label = '') {
            const optionsList = columnDiv.querySelector('.dropdown-options-list');
            const optionDiv = document.createElement('div');
            optionDiv.className = 'dropdown-option-row';
            optionDiv.style.marginBottom = '5px';
            optionDiv.innerHTML = `
                <input type="text" class="dropdown-value" placeholder="Option Value" value="${value}" style="width: 150px;">
                <input type="text" class="dropdown-label" placeholder="Option Label" value="${label}" style="width: 150px;">
                <button type="button" class="btn btn-danger remove-dropdown-option" style="margin-left: 10px;">Remove</button>
            `;
            optionsList.appendChild(optionDiv);

            optionDiv.querySelector('.remove-dropdown-option').addEventListener('click', function () {
                optionDiv.remove();
            });
        }

        document.getElementById('addColumnBtn').addEventListener('click', () => addColumn());

        // Create initial column
        addColumn();

        // Create Table Form
        document.getElementById('createTableForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const columns = [];
            const dropdownOptions = {};
            const columnRows = document.querySelectorAll('.column-row');

            columnRows.forEach(row => {
                const name = row.querySelector('.column-name').value;
                const type = row.querySelector('.column-type').value;
                if (name && type) {
                    columns.push({ name, type });

                    // Collect dropdown options for this column
                    const optionRows = row.querySelectorAll('.dropdown-option-row');
                    const options = [];
                    optionRows.forEach(optionRow => {
                        const value = optionRow.querySelector('.dropdown-value').value;
                        const label = optionRow.querySelector('.dropdown-label').value;
                        if (value && label) {
                            options.push({ value, label });
                        }
                    });

                    if (options.length > 0) {
                        dropdownOptions[name] = options;
                    }
                }
            });

            if (columns.length === 0) {
                alert('Please add at least one column to the table.');
                return;
            }

            const tableData = {
                tableName: document.getElementById('tableName').value,
                columns: columns,
                assignedUser: document.getElementById('assignedUser').value,
                dropdownOptions: dropdownOptions
            };

            fetch('/create_table', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(tableData)
            })
                .then(response => response.json())
                .then(data => {
                    const messageDiv = document.getElementById('tableMessage');
                    messageDiv.textContent = data.message;
                    messageDiv.className = data.success ? 'success' : 'error';

                    if (data.success) {
                        document.getElementById('createTableForm').reset();
                        document.getElementById('columnsContainer').innerHTML = '';
                        addColumn(); // Reset to one column
                        loadTables(); // Refresh tables list
                        loadTablesForAssignment(); // Refresh assignment tables
                    }
                });
        });

        // Assign Table Form
        document.getElementById('assignTableForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const assignData = {
                username: document.getElementById('assignUserSelect').value,
                tableName: document.getElementById('assignTableSelect').value
            };

            fetch('/assign_table_to_user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(assignData)
            })
                .then(response => response.json())
                .then(data => {
                    const messageDiv = document.getElementById('assignMessage');
                    messageDiv.textContent = data.message;
                    messageDiv.className = data.success ? 'success' : 'error';

                    if (data.success) {
                        document.getElementById('assignTableForm').reset();
                        // Show success message for 3 seconds
                        setTimeout(() => {
                            messageDiv.textContent = '';
                            messageDiv.className = '';
                        }, 3000);
                    }
                });
        });
    </script>
</body>

</html>